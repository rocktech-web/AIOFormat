<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>File Placeholder Replace & Download</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label, input, select, button { display: block; margin: 10px 0; font-size: 1em; }
  </style>
</head>
<body>
  <h2>AIOFormat — Placeholder Replace & Download</h2>

  <label for="fileSelect">GitHub से फाइल चुनें:</label>
  <select id="fileSelect">
    <option value="">-- फाइल चुनें --</option>
  </select>

  <label for="applicantName">नाम दर्ज करें:</label>
  <input type="text" id="applicantName" placeholder="{APPLICANTFULL}" />

  <button id="downloadBtn">डाउनलोड फाइल</button>

  <p id="status"></p>

  <script>
    const repoOwner = "rocktech-web";
    const repoName = "AIOFormat";
    const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/`;

    const sel = document.getElementById("fileSelect");
    const inp = document.getElementById("applicantName");
    const btn = document.getElementById("downloadBtn");
    const statusP = document.getElementById("status");

    // GitHub से फाइल सूची प्राप्त करें
    async function fetchFileList() {
      try {
        const resp = await fetch(apiUrl);
        if (!resp.ok) throw new Error("GitHub API error: " + resp.status);
        const data = await resp.json();
        data.forEach(item => {
          if (item.type === "file" && /\.(txt|json|html|md|docx|pdf)$/i.test(item.name)) {
            const opt = document.createElement("option");
            opt.value = JSON.stringify({
              name: item.name,
              url: item.download_url
            });
            opt.textContent = item.name;
            sel.appendChild(opt);
          }
        });
      } catch (err) {
        console.error(err);
        statusP.textContent = "फाइलें लोड नहीं हो सकीं: " + err.message;
      }
    }

    // डाउनलोड बटन इवेंट
    btn.addEventListener("click", async () => {
      const selected = sel.value;
      const nameEntered = inp.value.trim();
      if (!selected) return alert("कृपया एक फाइल चुनें।");
      if (!nameEntered) return alert("कृपया नाम दर्ज करें।");

      const { name: originalName, url: fileUrl } = JSON.parse(selected);
      const extension = originalName.split(".").pop(); // एक्सटेंशन प्राप्त करें

      statusP.textContent = "फ़ाइल डाउनलोड हो रही है...";

      try {
        const resp = await fetch(fileUrl);
        if (!resp.ok) throw new Error("Failed to fetch file: " + resp.status);
        const text = await resp.text();

        // placeholder को बदलें
        const replaced = text.split("{APPLICANTFULL}").join(nameEntered);

        // नई फाइल बनाएँ
        const blob = new Blob([replaced], { type: "text/plain" }); // MIME टाइप बेसिक रखा है
        const a = document.createElement("a");
        const newName = originalName.replace(/\.[^/.]+$/, "") + "_filled." + extension;
        a.download = newName;
        a.href = URL.createObjectURL(blob);
        a.click();
        URL.revokeObjectURL(a.href);

        statusP.textContent = "डाउनलोड पूरा हुआ!";
      } catch (err) {
        console.error(err);
        statusP.textContent = "त्रुटि: " + err.message;
      }
    });

    // पेज लोड होते ही फाइलें लाएं
    fetchFileList();
  </script>
</body>
</html>
